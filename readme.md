# Compliance

## Что это такое

В репозитории содержится результат работы по тестовому заданию на позицию Backend-разработчика.

> В рамках тестового задания предложено реализовать REST сервис на Ruby/Elixir, который позволит просматривать список репозиториев пользователей github.com, а так же коммиты в конкретном репозитории. В качестве тестовых данных можно использовать имя пользователя @matz и его репозиторий streem.

> Сервис должен принимать запросы на 4000 порт по путям: `/:login` и `/:login/:repository` и возвращать в виде JSON-структуры в первом случае список из десяти последних репозиториев, во-втором список последних коммитов в указанном репозитории. В случае ошибки необходимо вернуть текст ошибки в структуре, отраженной в документации тестового задания.

> В качестве источника данных необходимо использовать https://api.github.com/graphql. Для формирования запросов к API GitHub можно использовать любой HTTP-клиент (использовать официальные клиенты под GitHub API нельзя).

## Структура приложения

```bash
client
  |- request.rb             # Класс для формирования и отправки запроса в API Github
  |- response.rb            # Класс для проверки статуса запроса и возврата тела ответа
queries
  |- base_query.rb          # Класс для создания тела запроса в API Github по ряду параметров
  |- user.graphql           # Шаблон для запроса списка репозиториев пользователя
  |- commits.graphql        # Шаблон для запроса списка десяти последних коммитов к репозиторию
serializers
  |- base_serializer.rb     # Базовый родительский класс сериалайзеров, от которого наследуются прочие
  |- user_serializer.rb     # Сериалайзер для упаковки ответа на запрос списка репозиториев пользователя в необходимую структуру
  |- commits_serializer.rb  # Сериалайзер для упаковки ответа на запрос списка коммитов репозитория в необходимую структуру
  |- error_serializer.rb    # Сериалайзер для упаковки ответа c ошибкой
  |- unauth_serializer.rb   # Сериалайзер для упаковки ответа c ошибкой аутентификации
config.rb                   # Конфигурационный файл приложения
compliance.rb               # Основное приложение, без подключения сервера
app.rb                      # Сервер приложения, реализующий обработку HTTP-запросов по указанным в ТЗ роутам
Gemfile                     # Конфигурационный файл менеджера пакетов

... а также несколько вспомогательных директорий и файлов (тесты, конфиг CI, rubocop, ...), не влиящих на работу приложения.
```

## Как это работает
- Пользователь делает GET-запрос http://0.0.0.0:4000/matz.
- Запрос попадает в сервер Puma и форвардится в приложение Rack, являющееся интерфейсом между сервером и приложениями.
- Далее из Rack запрос уходит в класс `Server` файла app.rb, который является инстансом Sinatra::Base.
- `Server` матчит запрос на роут `/:login`.
- Внутри роута инстанс класса `Query` с предопределенным шаблоном `user.graphql` принимает `params[:login]` в качестве логина пользователя на GitHub.
- Далее инстанс загружает шаблон `user.graphql` и заменяет в нем переменную `{{login}}` на значение из `params[:login]`, формируя тело запроса к API GitHub.
- После этого тело запроса в методе `to_json` упаковывается в JSON-структуру, которую принимает API GitHub.
- Из метода `call` создается инстанс реквеста `Request.new`, в него передается JSON-структура для API GitHub и осуществляется запрос.
- Реквест после получения ответа возвращает класс `Response`, содержащий ответ и вспомогательные методы.
- С помощью метода `success?` проверяется, что ответ был успешным.
  - Из названия шаблона, переданного в качестве параметра в `Query` вычисляется имя необходимого сериалайзера.
  - Создается инстанс сериалайзера, в него передается тело полученного от API GitHub ответа.
  - Сериалайзер возвращает подготовленную структуру в виде хэша.
  - Структура конвертируется в JSON и отдается пользователю.
- В противном случае сообщение с ошибкой обрабатывается сериалайзером `ErrorSerializer`, полученный хэш конвертируеся в JSON и отдается пользователю.

## Установка и запуск

Перед любым вариантом установки (за исключением установки из doker-образа) необходимо указать две переменные:
1. `ENV['GITHUB_TOKEN']` — токен для аутотентификации в API Github ([см. инструкцию](https://help.github.com/articles/creating-a-personal-access-token-for-the-command-line/)).
2. `ENV['APP_ENV']` — режим приложения: 'test', 'development', 'production'.

Обе переменные также можно указать в конфиге приложения `config.rb`, но приоритетными являются переменные среды.

**Запуск локально**
```bash
> git clone https://github.com/creadone/compliance.git
> bundle install
> ruby app.rb
```

**Запуск как Rack-приложение**
```bash
> git clone https://github.com/creadone/compliance.git
> bundle install
> rackup app.ru -p 4000
```

**Из docker-образа**
```bash
> docker pull creadone/compliance
> docker run -e GITHUB_TOKEN=[YOU-KEY] --rm -d -p 4000:4000 --name app creadone/compliance
```

## Тестирование

```bash
bundle exec rspec spec
```
